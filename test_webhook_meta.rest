### Tests Webhook Meta (Messenger/Instagram)

# Variables
@baseUrl = http://localhost:3000
@verifyToken = XamXam_W3bH0oK_S3cr3T_Str1n9_2025
@appSecret = ba96e8eb436abd6c4284bd329aa09efd

### 1. GET - Vérification du webhook (simulation Meta)
GET {{baseUrl}}/api/webhooks/meta?hub.mode=subscribe&hub.verify_token={{verifyToken}}&hub.challenge=test_challenge_123
Content-Type: application/json

###

### 2. GET - Vérification avec mauvais token (doit échouer)
GET {{baseUrl}}/api/webhooks/meta?hub.mode=subscribe&hub.verify_token=wrong_token&hub.challenge=test_challenge_123
Content-Type: application/json

###

### 3. POST - Simulation message Messenger entrant
POST {{baseUrl}}/api/webhooks/meta
Content-Type: application/json
X-Hub-Signature-256: sha256=SIGNATURE_TO_CALCULATE

{
  "object": "page",
  "entry": [
    {
      "id": "PAGE_ID",
      "time": 1234567890,
      "messaging": [
        {
          "sender": {
            "id": "USER_ID_123"
          },
          "recipient": {
            "id": "PAGE_ID"
          },
          "timestamp": 1234567890,
          "message": {
            "mid": "MESSAGE_ID_123",
            "text": "Bonjour, je suis intéressé par vos produits !"
          }
        }
      ]
    }
  ]
}

###

### 4. POST - Simulation message Instagram DM entrant
POST {{baseUrl}}/api/webhooks/meta
Content-Type: application/json
X-Hub-Signature-256: sha256=SIGNATURE_TO_CALCULATE

{
  "object": "instagram",
  "entry": [
    {
      "id": "INSTAGRAM_ACCOUNT_ID",
      "time": 1234567890,
      "messaging": [
        {
          "sender": {
            "id": "INSTAGRAM_USER_ID_456"
          },
          "recipient": {
            "id": "INSTAGRAM_ACCOUNT_ID"
          },
          "timestamp": 1234567890,
          "message": {
            "mid": "INSTAGRAM_MESSAGE_ID_456",
            "text": "Salut ! Avez-vous ce produit en stock ?"
          }
        }
      ]
    }
  ]
}

###

### 5. POST - Message avec pièce jointe (image)
POST {{baseUrl}}/api/webhooks/meta
Content-Type: application/json
X-Hub-Signature-256: sha256=SIGNATURE_TO_CALCULATE

{
  "object": "page",
  "entry": [
    {
      "id": "PAGE_ID",
      "time": 1234567890,
      "messaging": [
        {
          "sender": {
            "id": "USER_ID_789"
          },
          "recipient": {
            "id": "PAGE_ID"
          },
          "timestamp": 1234567890,
          "message": {
            "mid": "MESSAGE_ID_789",
            "attachments": [
              {
                "type": "image",
                "payload": {
                  "url": "https://example.com/image.jpg"
                }
              }
            ]
          }
        }
      ]
    }
  ]
}

###

### Notes pour les tests :
# 1. Pour calculer la signature X-Hub-Signature-256, utilisez :
#    sha256=HMAC_SHA256(app_secret, request_body)
# 2. Remplacez PAGE_ID par l'ID de votre page Facebook
# 3. Remplacez USER_ID par un ID utilisateur test
# 4. Assurez-vous que les variables d'environnement sont configurées :
#    - META_VERIFY_TOKEN
#    - FACEBOOK_APP_SECRET

### Script Node.js pour calculer la signature (à exécuter séparément) :
# const crypto = require('crypto');
# const appSecret = 'ba96e8eb436abd6c4284bd329aa09efd';
# const body = JSON.stringify(payload);
# const signature = crypto.createHmac('sha256', appSecret).update(body).digest('hex');
# console.log('X-Hub-Signature-256: sha256=' + signature);